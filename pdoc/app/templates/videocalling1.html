<!doctype html>
<html lang="en">

<head>
  {% load static %}
  <link rel="shortcut icon" href="#">
  <script src='https://cdn.scaledrone.com/scaledrone.min.js'></script>
  <script src="https://api.html5media.info/1.1.5/html5media.min.js"></script>
  <title>PDOC | VideoCalling</title>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
    integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous" />
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Rubik:ital,wght@0,300;0,400;0,500;0,700;0,900;1,300;1,400;1,500;1,700;1,900&amp;display=swap">
  <style>
    * {
      font-family: "Rubik", sans-serif;
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .vc-body {
      background-color: rgb(0, 0, 0);
    }

    #vd-head {
      position: relative;
      background: url("{% static 'connecting.png' %}");
      background-position: center;
      background-size: contain;
      background-repeat: no-repeat;
      height: 100vh;
      width: 100%;
      overflow: hidden;
      object-fit: contain;
      object-position: center;
    }

    #vd-head .video-remote {
      position: absolute;
      top: 50%;
      left: 50%;
      min-width: auto;
      min-height: 100%;
      width: auto;
      height: auto;
      z-index: 0;
      transform: translateX(-50%) translateY(-50%);
      -webkit-transform: translateX(-50%) translateY(-50%);
      /* Safari and Chrome */
      -moz-transform: translateX(-50%) translateY(-50%);
      /* -webkit-transform: translateX(-50%) translateY(-50%); */
      /* transform: translateX(-50%) translateY(-50%); */
    }

    #vd-head .container {
      position: relative;
      z-index: 2;
      background-color: transparent;
    }

    #vd-head .overlay {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      z-index: 1;
      background-color: transparent;
    }

    @media (pointer: coarse) and (hover: none) {
      #vd-head {
        background: url("{% static 'connecting.png' %}") transparent no-repeat center center scroll;
        object-position: center;
        object-fit: contain;
        background-position: center;
        background-size: contain;
      }
    }

    .vc-buttons {
      z-index: 3;
      position: absolute;
      bottom: 10%;
      left: 0;
      right: 0;
    }

    .min-btn {
      width: 60px;
      height: 60px;
      color: white;
      background-color: #2e2e2e;
      margin: 10px;
      border: none;
      border-radius: 50%;
      padding: 10px;
      font-size: 1.5rem;
      outline: none;
    }

    .min-btn:focus,
    .min-btn-red:focus {
      outline: none;
    }

    .min-btn-red {
      width: 60px;
      height: 60px;
      color: white;
      background-color: #de2626;
      margin: 10px;
      border: none;
      border-radius: 50%;
      padding: 10px;
      font-size: 1.5rem;
    }

    .min-btn-red:hover,
    .min-btn:hover {
      cursor: pointer;
      box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.5);
      -webkit-transform: scale(1.1);
      transform: scale(1.1);
    }

    .vc-av-status {
      display: none;
    }

    .drag-area {
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      touch-action: none;

      background-color: transparent;
    }

    .video-local {
      z-index: 3;
      width: 20%;
      background-image: url("{% static 'connecting.png' %}");
      object-fit: contain;
      object-position: center;
      border: 1px solid #75757577;
      border-radius: 5px;
      touch-action: none;
      user-select: none;
      margin: 3%;
      transform: rotateY(180deg);
      -webkit-transform: rotateY(180deg);
      /* Safari and Chrome */
      -moz-transform: rotateY(180deg);
    }

    .video-local:hover {
      cursor: move;
      box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.5);
      -webkit-transform: scale(1.1) rotateY(180deg);
      transform: scale(1.1) rotateY(180deg);
    }

    .vc-d-box {
      display: none;
      position: absolute;
      z-index: 3;
      background-color: #f1f1f1;
      text-align: center;
      border: 1px solid #d3d3d3;
      float: right !important;
      top: 1%;
      width: 40%;
      border-radius: 10px;
    }

    .vc-d-box-header {
      padding: 10px;
      cursor: move;

      background-color: #cccccc6c;
      color: rgb(0, 0, 0);
    }

    .tinyarea {
      width: 100%;
      border: 0px
    }

    .vc-d-box-close {
      border: none;
      float: right;
      color: #de2626;
      background-color: transparent;
    }

    .med-repo {
      max-height: 300px;
      overflow-y: auto;
    }

    .patient-docs {
      max-height: 350px;
      overflow-y: auto;
    }

    .custom-d-file {
      max-height: 100px;
      width: 100%;
      height: 100%;
      object-position: center;
      object-fit: cover;
    }

    .My {
      display: none;
      /* Hidden by default */
      position: fixed;
      /* Stay in place */
      z-index: 3;
      /* Sit on top */
      padding-top: 100px;
      /* Location of the box */
      left: 0;
      top: 0;
      width: 100%;
      /* Full width */
      height: 100%;
      /* Full height */
      overflow: auto;
      /* Enable scroll if needed */
      background-color: rgb(0, 0, 0);
      /* Fallback color */
      background-color: rgba(0, 0, 0, 0.9);
      /* Black w/ opacity */
    }

    /* Modal Content (image) */
    .Mymodal-content {
      margin: auto;
      display: block;
      width: 80%;

    }

    /* Add Animation */
    .Mymodal-content {
      -webkit-animation-name: zoom;
      -webkit-animation-duration: 0.6s;
      animation-name: zoom;
      animation-duration: 0.6s;
    }

    @-webkit-keyframes zoom {
      from {
        -webkit-transform: scale(0)
      }

      to {
        -webkit-transform: scale(1)
      }
    }

    @keyframes zoom {
      from {
        transform: scale(0)
      }

      to {
        transform: scale(1)
      }
    }

    /* The Close Button */
    .Myclose {
      position: absolute;
      top: 15px;
      right: 35px;
      color: #f1f1f1;
      font-size: 40px;
      font-weight: bold;
      transition: 0.3s;
    }

    .Myclose:hover,
    .Myclose:focus {
      color: #bbb;
      text-decoration: none;
      cursor: pointer;
    }

    .up-status {
      display: none;
    }

    @media only screen and (max-width: 600px) {
      .video-local {
        width: 30%;
        border: 1px solid rgba(136, 136, 136, .5);
        border-radius: 5px;
      }

      .vc-d-box {
        width: 100% !important;
        align-self: right;
        top: 0%;
      }

      .d-sm-none {
        display: none;
      }

      #vd-head .video-remote {
        width: 100%;
      }

      .med-repo {
        max-height: 250px;
        overflow-y: auto;
      }

      .patient-docs {
        max-height: 250px;
        overflow-y: auto;
      }

      .Mymodal-content {
        width: 100%;
      }

      .min-btn,
      .min-btn-red {
        width: 40px;
        height: 40px;
        font-size: .9rem;
      }
    }

    .pop-up-body {
      width: 100%;
      height: 100vh;
      position: absolute;
      z-index: 9999;
      background-color: #000000e1;
      display: none;
    }

    .pop-up-dismis {
      display: none;
    }

    .go-back {
      display: none;
    }

    .pop-up {
      width: 40%;
      height: 40%;
      position: fixed;
      border: 0.5px solid grey;
      border-radius: 5px;
      background-color: #ffffff;
      background-image: url("{% static 'index/site_images/plusBG.png' %}");
      background-position: top;
      background-size: contain;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      margin: auto;

    }

    .pl-wt {
      font-size: 1.7rem;
      font-weight: 500;
    }

    .pl-wt small {
      font-size: 1rem;
      font-weight: 100;
    }

    @media only screen and (max-width: 600px) {
      .pop-up {
        width: 80%;
      }

      .pl-wt {
        font-size: 1.5rem !important;
        font-weight: 500;
      }

      .pl-wt small {
        font-size: 0.8rem !important;
        font-weight: 100;
      }
    }
  </style>

</head>

<body class="vc-body">
  <div class="pop-up-body">
    <div class="pop-up">
      <div class="container">
        <div class="row">
          <div class="col-12 col-md-12 col-sm-12 text-center pt-5">
            <div class="spinner-grow text-primary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-secondary" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-success" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-danger" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-warning" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-info" role="status">
              <span class="sr-only">Loading...</span>
            </div>
            <div class="spinner-grow text-dark" role="status">
              <span class="sr-only">Loading...</span>
            </div>
          </div>
          <div class="col-12 col-md-12 col-sm-12 text-center mt-3 mt-md-5">
            <p class="pl-wt "><span class="main-status">Please Wait..</span>
              <br><small class="sub-status">The Doctor hasn't Joined yet.</small>
            </p>
            <button class="btn btn-success pop-up-dismis">Continue</button>
            <button class="btn btn-danger go-back">Exit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid vc-cont p-0">
    <div class="row no-gutters">
      <header id="vd-head">
        <div class="overlay"></div>
        <video id="remoteVideo" class="video-remote" playsinline="playsinline" autoplay loop="loop">
          <source src="{% static 'connecting.png' %}" type="video/mp4">
        </video>
        <div class="container-fluid h-100 p-0">
          <!-- Buttons -->
          <div class="row vc-buttons text-center">
            <div class="col-12 col-md-6 col-sm-12 text-center mx-auto my-auto pt-2 pb-2 vc-av-status pl-2 pv-2"
              style="margin-bottom: 100px;background-color: #ffacac;color: #de2626;border: solid #de2626;border-radius: 5px;opacity: .7;">
              ...</div>
            <div class="col-12 text-center mx-auto mt-3">
              <button id="mute" class="min-btn text-center" data-toggle="tooltip" data-placement="top"
                title="Mute/Unmute" onclick="toggleMic()"><i class="fa fa-microphone-slash" id="mute-icon"></i></button>
              <button id="video-off" class="min-btn text-center" data-toggle="tooltip" data-placement="top"
                title="Video On/Off" onclick="toggleVideo()"><i class="fa fa-pause" id="pause-icon"></i></button>
              {% if doctor %}
              <button id="presc-btn" class="min-btn text-center" data-toggle="tooltip" data-placement="top"
                title="Prescribe"><i class="fa fa-pencil-square-o"></i></button>
              <button id="pati-file" class="min-btn text-center" data-toggle="tooltip" data-placement="top"
                title="Files"><i class="fa fa-folder-open"></i></button>
              {% endif %}
              {% if doctor != True %}
              <button id="presc-btn-patient" class="min-btn text-center" data-toggle="tooltip" data-placement="top"
                title="My Prescription"><i class="fa fa-book"></i></button>
              <button id="file-up" class="min-btn text-center" data-toggle="tooltip" data-placement="top"
                title="Upload Docs"><i class="fa fa-upload"></i></button>
              {% endif %}
              <button id="end" class="min-btn-red text-center" data-toggle="tooltip" data-placement="top" title="End"><i
                  class="fa fa-stop"></i></button>
            </div>
          </div>

          <div class="d-flex h-100 text-center align-items-right">
            <div id="drag-area" class="w-100">
              <!-- Local Video -->
              <video id="localVideo" class="video-local" playsinline="playsinline" poster="{% static 'fetching.png' %}"
                autoplay loop="loop" muted>
                <source src="{% static 'connecting.png' %}" type="video/mp4">
              </video>
              <!--Experiment-->
              <script>
                var customerID;
                customerID = '{{customer}}';
              </script>
              {% if doctor != True %}
              <div id="prescribe-patient" class="vc-d-box">
                <div id="prescribeheader-patient" class="vc-d-box-header">My Prescription<button
                    class="pres-close-patient vc-d-box-close"><i class="fa fa-times" aria-hidden="true"></i></button>
                </div>
                <div class="container-fluid pt-2 pb-3 med-add">
                  <div class="row no-gutters text-left">
                    <div class="col-6 mx-auto my-auto">
                      <h1>PDOC</h1>
                      EDOC Medical Services
                    </div>
                    <div class="col-6 ">
                      Name: <strong>Dr. {{name}}</strong><br>
                      Designation: <strong>{{designation}}</strong><br>
                      Reg no: <strong>{{practice_id}}</strong>
                    </div>

                  </div>
                  <hr>
                  <div class="row no-gutters text-left mt-1 mb-2 pl-5 pr-5">
                    <div class="col-12 mx-auto my-auto">
                      <p>
                        <pre id="summary-patient"></pre>
                      </p>
                    </div>
                  </div>
                  <hr>
                  <div class="row no-gutters text-left mt-1 mb-2">
                    <div class="col-12 mx-auto my-auto">
                      <ol class="med-repo">
                        <h4>Medicines List</h4>

                      </ol>
                    </div>
                  </div>
                </div>
              </div>
              <div id="file-patient" class="vc-d-box">
                <div id="prescribeheader-patient" class="vc-d-box-header">My Files<button
                    class="file-close-patient vc-d-box-close"><i class="fa fa-times" aria-hidden="true"></i></button>
                </div>
                <div class="container-fluid pt-2 pb-3 med-add">
                  <h5 class="text-left pl-2 pt-3 pb-3">Upload a document</h5>
                  <div class="row no-gutters text-left">

                    <div class="col-12 col-md-7 mx-auto my-auto md-pr-3 sm-pb-5">
                      <div class="custom-file form-group">
                        <input type="text" class="form-control" id="docu-name" name="docu-name"
                          aria-describedby="textHelp" placeholder="Enter File Name" required>
                      </div>
                    </div>

                    <div class="col-12 col-md-5 mx-auto my-auto">
                      <div class="input-group">
                        <div class="custom-file">
                          <input type="file" class="custom-file-input" id="files">
                          <label class="custom-file-label" for="files">Select File</label>
                        </div>
                        <div class="md-pl-2 ">
                          <button class="btn btn-success" type="button" id="send">Upload</button>
                        </div>
                      </div>
                    </div>
                  </div>
                  <hr>
                  <h5 class="text-left pl-2 pt-3 pb-3">All Documents</h5>
                  <div class="row no-gutters text-left patient-docs store-files  text-center mx-auto">
                    NO Files Yet....
                  </div>
                </div>
              </div>
              <div id="up-status" class="Mymodal up-status">
                <div class="container">
                  <div class="row ptb-100 pl-5 pr-5" style="background-color: whitesmoke;">
                    <div class="col-12 ptb-100 pl-5 pr-5">
                      <br>
                      <h4 class="text-center">Uploading Status</h4>
                      <progress class="mt-5" value="0" max="100" id="progress" style="width: 100%;"></progress>
                      <p id="uploading"></p>
                    </div>
                  </div>
                </div>

              </div>
              {% endif %}
              <!--Experiment -->
              <div id="prescribe" class="vc-d-box">
                <div id="prescribeheader" class="vc-d-box-header">Prescribe<button class="pres-close vc-d-box-close"><i
                      class="fa fa-times" aria-hidden="true"></i></button></div>
                <textarea class="tinyarea" name="tiny" id="summary" cols="30" rows="10"
                  placeholder="Prescribe here"></textarea>
                <div class="container-fluid pt-2 pb-3 med-add">
                  <div class="med-repo">

                    <div class="row no-gutters mt-1 mb-3 med-row" data-count="1">
                      <div class="col-md-4 col-sm-12 my-auto">
                        <input type="text" class="form-control medicine pushMed" placeholder="Enter Medicine Name">
                      </div>
                      <div class="col-md-4 col-sm-12 med-time">
                        M-<input type="checkbox" id="m-1" name="" class="M-medicine pushMed">&nbsp;&nbsp;
                        A-<input type="checkbox" id="l-1" name="" class="L-medicine pushMed">&nbsp;&nbsp;
                        E-<input type="checkbox" id="s-1" name="" class="S-medicine pushMed">&nbsp;&nbsp;
                        N-<input type="checkbox" id="d-1" name="" class="D-medicine pushMed">
                        <br>
                        <input type="checkbox" name="" class="aftFood-medicine pushMed"> Aft Food
                        <input type="checkbox" name="" class="befFood-medicine pushMed"> Bef Food
                      </div>
                      <div class="col-6 col-md-2 col-sm-6 my-auto">
                        <input type="text" class="form-control quantity-medicine pushMed" placeholder="Quantity">
                      </div>
                      <div class="col-6 col-md-2 col-sm-6 col-xs-3 my-auto">
                        <input type="text" class="form-control period-medicine pushMed" placeholder="Period">
                      </div>
                      <div class="col-md-12 col-sm-12 my-auto">
                        <input type="text" class="form-control remark-medicine pushMed" placeholder="Remark">
                      </div>
                    </div>
                  </div>
                  <button id="add-more-med" type="button" class="btn btn-secondary btn-sm btn-block">Add More</button>
                  <button id="prescribe-submit" type="button"
                    class="btn btn-primary btn-sm btn-block">Prescribe</button>
                </div>
              </div>
              <div id="file-doctor" class="vc-d-box">
                <div id="prescribeheader-patient" class="vc-d-box-header">Patient's Files<button
                    class="file-close-doctor vc-d-box-close"><i class="fa fa-times" aria-hidden="true"></i></button>
                </div>
                <div class="container-fluid pt-2 pb-3 med-add">
                  <h5 class="text-left pl-2 pt-3 pb-3">All Documents</h5>
                  <div class="row no-gutters text-left patient-docs store-files">
                    NO Files Yet....
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </header>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"
    integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>
  <script src="https://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"
    integrity="sha512-0bEtK0USNd96MnO4XhH8jhv3nyRF0eK87pJke6pkYf3cM0uDIhNJy9ltuzqgypoIFXw3JSuiy04tVk4AjpZdZw=="
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
  </script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
  </script>
  <script>
    //local video
    var radio_id = 1;
    $('.video-local').css('float', 'right');
    document.getElementById("prescribe").style["float"] = "right";
    $(function () {
      if (window.matchMedia("(min-width: 767px)").matches) {
        $("#prescribe").draggable({
          containment: "#drag-area"
        });
        $("#prescribe-patient").draggable({
          containment: "#drag-area"
        });
        $("#file-doctor").draggable({
          containment: "#drag-area"
        });
        $("#file-patient").draggable({
          containment: "#drag-area"
        });
      }
      $("#localVideo").draggable({
        containment: "#drag-area"
      });
    });
    $("#add-more-med").click(function () {
      radio_id++;
      $(".med-repo").append('<div class="row no-gutters mt-1 mb-1 med-row" data-count="' + radio_id +
        '"><div class="col-md-4 col-sm-12 my-auto"><input type="text" class="form-control medicine pushMed" placeholder="Enter Medicine Name"></div><div class="col-md-4 col-sm-12 med-time">M-<input type="checkbox" name="" id="m-' +
        radio_id + '" class="M-medicine pushMed">&nbsp;&nbsp; A-<input type="checkbox" name="" id="l-' +
        radio_id + '" class="L-medicine pushMed">&nbsp;&nbsp;E-<input type="checkbox" name="" id="s-' + radio_id +
        '" class="S-medicine pushMed">&nbsp;&nbsp; N-<input type="checkbox" name="" id="d-' + radio_id +
        '" class="D-medicine pushMed"><br><input type="checkbox" name="" class="aftFood-medicine pushMed"> Aft Food<input type="checkbox" name="" class="befFood-medicine pushMed"> Bef Food</div><div class="col-6 col-md-2 col-sm-6 my-auto"><input type="text" class="form-control quantity-medicine pushMed" placeholder="Quantity"></div><div class="col-6 col-md-2 col-sm-6 col-xs-3 my-auto"><input type="text" class="form-control period-medicine pushMed" placeholder="Period"></div><div class="col-md-12 col-sm-12 my-auto"><input type="text" class="form-control remark-medicine pushMed" placeholder="Remark"></div></div>'
      );
      $('.med-repo').scrollTop($('.med-repo')[0].scrollHeight);
    });

    $("#presc-btn").click(function () {
      $("#file-doctor").hide();
      $("#prescribe").show();
    });
    $(".pres-close").click(function () {
      $("#prescribe").hide();
    });
    $("#presc-btn-patient").click(function () {
      $("#file-patient").hide();
      $("#prescribe-patient").show();
    });
    $(".pres-close-patient").click(function () {
      $("#prescribe-patient").hide();
    });

    $("#file-up").click(function () {
      $("#prescribe-patient").hide();
      $("#file-patient").show();
    });
    $(".file-close-patient").click(function () {
      $("#file-patient").hide();
    });
    $("#pati-file").click(function () {
      $("#prescribe").hide();
      $("#file-doctor").show();
    });
    $(".file-close-doctor").click(function () {
      $("#file-doctor").hide();
    });
  </script>
  <script src="https://www.gstatic.com/firebasejs/6.2.4/firebase.js"></script>
  <script>
    var doctor = '{{doctor}}';
  </script>
  <script src="{% static 'adapter.js' %}"></script>
  <script src="{% static 'script.js' %}"></script>
  <script>
    function makeid(length) {
      var result = '';
      var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      var charactersLength = characters.length;
      for (var i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * charactersLength));
      }
      return result;
    }
    var database;
    var files = [];
    var metadata;
    var ext;
    var re = /(?:\.([^.]+))?$/;
    if (doctor == "False") {
      document.getElementById("files").addEventListener("change", function (e) {
        files = e.target.files;
        for (let i = 0; i < files.length; i++) {
          console.log(files[i]);
          ext = re.exec(files[i].name)[1];
          console.log("hii" + ext);
          metadata = {
            contentType: files[i].type
          };
          console.log(metadata);
        }

      });
      document.getElementById("send").addEventListener("click", function () {
        var inp = document.getElementById('docu-name');
        inp.focus();
        document.execCommand('SelectAll');
        var filesName = window.getSelection().toString();
        if (files.length != 0 && filesName != "") {
          for (let i = 0; i < files.length; i++) {
            var storage = firebase.storage().ref('records/' + customerID + '/' + filesName + '.' + ext);
            var uploadTask = storage.put(files[i], metadata);
            uploadTask.on('state_changed', function (snapshot) {
              var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
              document.getElementById("up-status").style.display = "block";
              document.getElementById("progress").value = progress;
              console.log('Upload is ' + progress + '% done');
              if (progress == 100) {
                document.getElementById("uploading").innerHTML =
                  `<span style="color:green">Uploaded Successfully</span> <br />`;
                setTimeout(function () {
                  document.getElementById("up-status").style.display = "none";
                }, 2000);
                database = firebase.database();
                database.ref('Stats/' + customerID).set({
                  "upload": "Uploaded " + filesName
                });
              }
              switch (snapshot.state) {
                case firebase.storage.TaskState.PAUSED: // or 'paused'
                  console.log('Upload is paused');
                  break;
                case firebase.storage.TaskState.RUNNING: // or 'running'
                  console.log('Upload is running');
                  break;
              }
            }, function (error) {
              document.getElementById("uploading").innerHTML +=
                `<span style="color:red">Upload Failed</span> <br />`;
            }, function () {
              // Handle successful uploads on complete
              // For instance, get the download URL: https://firebasestorage.googleapis.com/...
              uploadTask.snapshot.ref.getDownloadURL().then(function (downloadURL) {
                console.log('File available at', downloadURL);
              });
            });
          }
        } else {
          alert("Choose a file and a name");
        }
      });
    }

    function getFileUrl(filename) {
      var storage = firebase.storage().ref(filename);
      storage
        .getDownloadURL()
        .then(function (url) {
          console.log(url);
        })
        .catch(function (error) {
          console.log("error encountered");
        });
    }
    database.ref('Stats/' + customerID).on("value", function (snapshot) {
      data = snapshot.val();
      reFetchStorage();
    }, function (errorObject) {
      console.log("The read failed: " + errorObject.code);
    });

    //new Storage ups
    function reFetchStorage() {
      setTimeout(function () {
        $(".store-files").html('');
        var listRef = firebase.storage().ref('records/' + customerID + '/');
        listRef.listAll().then(function (res) {
          res.items.forEach(function (itemRef) {
            //console.log( itemRef.toString() );
            itemRef.getDownloadURL().then(function (url) {
              var ranID = makeid(9);
              var funId = "'" + ranID + "'";
              var str;
              if (itemRef.name.length > 10) str = itemRef.name.substring(0, 7) + '...';
              else str = itemRef.name;
              $(".store-files").append(
                '<div class="col-4 col-md-3 col-sm-4 pl-2 pr-2" > <embed class="img-thumbnail custom-d-file" type="image/jpg" src="' +
                url + '" onclick="showModal(' + funId +
                ')"><p class="text-center pl-2 pr-2 mb-3 w-100"style="background-color:white"><small>' +
                str + '</small></p></div><div id="' + ranID +
                '" class="Mymodal"> <span onclick="hideModal(' + funId +
                ')" class="Myclose">&times;</span> <embed ' +
                'src="' + url + '"' + 'class="Mymodal-content"> </div>  ');
            })
          });
        }).catch(function (error) {});
      }, 3000);
    }

    function showModal(id) {
      var x = document.getElementById(id);
      x.style.display = "block";
    }

    function hideModal(id) {
      var x = document.getElementById(id);
      x.style.display = "none";
    }
  </script>
  <script>
    var vcRefx = database.ref("active-meetings/" + roomHash + "/");
    vcRefx.update({
      "vc-pat-status": "false",
      "vc-doc-status": "false"
    })
    if (doctor != "True") {
      $(".pop-up-body").show(500);
      $(".pop-up-dismis").click(function () {
        $(".pop-up-dismis").hide(500);
        $(".pop-up-body").hide(500);
      });
      var d;
      var vcNum;

      function timeUp() {
        d = new Date();
        vcNum = d.getTime();
        var vcRef = database.ref("active-meetings/" + roomHash + "/");
        vcRef.update({
          "vc-pat": vcNum,
          "vc-pat-status": "true"
        })
        setTimeout(timeUp, 5000);
      }
      timeUp();
      var vcRefGetPat = database.ref("active-meetings/" + roomHash + "/" + "vc-doc");
      vcRefGetPat.on("value", function (snapshot) {
        getNumPat = snapshot.val();
        //console.log(Math.abs(getNumPat - vcNum));
        if (Math.abs(getNumPat - vcNum) < 5000) {
          //console.log("doctor Joined");
          $(".main-status").html("Doctor has Joined");
          $(".sub-status").html("Click on continue...");
          $(".pop-up-dismis").show();
        }
      }, function (error) {
        console.log("Error: " + error.code);
      });
    }

    if (doctor == "True") {
      function timeUpDoc() {
        var dDoc = new Date();
        var vcNumDoc = dDoc.getTime();
        var vcRefDoc = database.ref("active-meetings/" + roomHash + "/");
        vcRefDoc.update({
          "vc-doc": vcNumDoc,
          "vc-doc-status": "true"
        })
        setTimeout(timeUpDoc, 5000);
      }
      timeUpDoc();
    }
    var getDocTS, getPatTS, PatStat, DocStat;

    var vcDocStat = database.ref("active-meetings/" + roomHash + "/" + "vc-doc-status");
    vcDocStat.on("value", function (snapshot) {
      DocStat = snapshot.val();
    }, function (error) {
      console.log("Error: " + error.code);
    });
    var vcPatStat = database.ref("active-meetings/" + roomHash + "/" + "vc-pat-status");
    vcPatStat.on("value", function (snapshot) {
      PatStat = snapshot.val();
    }, function (error) {
      console.log("Error: " + error.code);
    });


    var DocTSRef = database.ref("active-meetings/" + roomHash + "/" + "vc-doc");
    DocTSRef.on("value", function (snapshot) {
      getDocTS = snapshot.val();
      if (Math.abs(getDocTS - getPatTS) > 15000 && DocStat == "true" && PatStat == "true") {
        console.log("Problem Occoured");
        $(".pop-up-body").show(500);
        $(".main-status").html("You are Disconnected...");
        $(".sub-status").html("Our team will call you soon.");
        $(".go-back").show();
        $(".go-back").click(function () {
          var vcRefx = database.ref("active-meetings/" + roomHash + "/");
          vcRefx.update({
            "vc-pat-status": "false",
            "vc-doc-status": "false"
          })
          $(".go-back").hide();
          window.history.back();
        });
      }
    }, function (error) {
      console.log("Error: " + error.code);
    });

    var PatTSRef = database.ref("active-meetings/" + roomHash + "/" + "vc-pat");
    PatTSRef.on("value", function (snapshot) {
      getPatTS = snapshot.val();
      if (Math.abs(getDocTS - getPatTS) > 15000 && DocStat == "true" && PatStat == "true") {
        //console.log("Problem Occoured");
        $(".pop-up-body").show(500);
        $(".main-status").html("You are Disconnected...");
        $(".sub-status").html("Our team will call you soon.");
        $(".go-back").show();
        $(".go-back").click(function () {
          var vcRefx = database.ref("active-meetings/" + roomHash + "/");
          vcRefx.update({
            "vc-pat-status": "false",
            "vc-doc-status": "false"
          })
          $(".go-back").hide();
          window.history.back();
        });
      }
    }, function (error) {
      console.log("Error: " + error.code);
    });
  </script>

</body>

</html>

